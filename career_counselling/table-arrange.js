jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(e){e=e||{};this.each(function(){this.tableDnDConfig={onDragStyle:e.onDragStyle,onDropStyle:e.onDropStyle,onDragClass:e.onDragClass?e.onDragClass:"tDnD_whileDrag",onDrop:e.onDrop,onDragStart:e.onDragStart,scrollAmount:e.scrollAmount?e.scrollAmount:5};jQuery.tableDnD.makeDraggable(this)});jQuery(document).bind("mousemove",jQuery.tableDnD.mousemove).bind("mouseup",jQuery.tableDnD.mouseup);return this},makeDraggable:function(e){var t=e.rows;var n=e.tableDnDConfig;for(var r=0;r<t.length;r++){var i=$(t[r]).hasClass("nodrag");if(!i){jQuery(t[r]).mousedown(function(t){if(t.target.tagName=="TD"){jQuery.tableDnD.dragObject=this;jQuery.tableDnD.currentTable=e;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,t);if(n.onDragStart){n.onDragStart(e,this)}return false}}).css("cursor","move")}}},mouseCoords:function(e){if(e.pageX||e.pageY){return{x:e.pageX,y:e.pageY}}return{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(e,t){t=t||window.event;var n=this.getPosition(e);var r=this.mouseCoords(t);return{x:r.x-n.x,y:r.y-n.y}},getPosition:function(e){var t=0;var n=0;if(e.offsetHeight==0){e=e.firstChild}while(e.offsetParent){t+=e.offsetLeft;n+=e.offsetTop;e=e.offsetParent}t+=e.offsetLeft;n+=e.offsetTop;return{x:t,y:n}},mousemove:function(e){if(jQuery.tableDnD.dragObject==null){return}var t=jQuery(jQuery.tableDnD.dragObject);var n=jQuery.tableDnD.currentTable.tableDnDConfig;var r=jQuery.tableDnD.mouseCoords(e);var i=r.y-jQuery.tableDnD.mouseOffset.y;var s=window.pageYOffset;if(document.all){if(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat"){s=document.documentElement.scrollTop}else if(typeof document.body!="undefined"){s=document.body.scrollTop}}if(r.y-s<n.scrollAmount){window.scrollBy(0,-n.scrollAmount)}else{var o=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;if(o-(r.y-s)<n.scrollAmount){window.scrollBy(0,n.scrollAmount)}}if(i!=jQuery.tableDnD.oldY){var u=i>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=i;if(n.onDragClass){t.addClass(n.onDragClass)}else{t.css(n.onDragStyle)}var a=jQuery.tableDnD.findDropTargetRow(t,i);if(a){if(u&&jQuery.tableDnD.dragObject!=a){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,a.nextSibling)}else if(!u&&jQuery.tableDnD.dragObject!=a){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,a)}}}return false},findDropTargetRow:function(e,t){var n=jQuery.tableDnD.currentTable.rows;for(var r=0;r<n.length;r++){var i=n[r];var s=this.getPosition(i).y;var o=parseInt(i.offsetHeight)/2;if(i.offsetHeight==0){s=this.getPosition(i.firstChild).y;o=parseInt(i.firstChild.offsetHeight)/2}if(t>s-o&&t<s+o){if(i==e){return null}var u=jQuery.tableDnD.currentTable.tableDnDConfig;if(u.onAllowDrop){if(u.onAllowDrop(e,i)){return i}else{return null}}else{var a=$(i).hasClass("nodrop");if(!a){return i}else{return null}}return i}}return null},mouseup:function(e){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){var t=jQuery.tableDnD.dragObject;var n=jQuery.tableDnD.currentTable.tableDnDConfig;if(n.onDragClass){jQuery(t).removeClass(n.onDragClass)}else{jQuery(t).css(n.onDropStyle)}jQuery.tableDnD.dragObject=null;if(n.onDrop){n.onDrop(jQuery.tableDnD.currentTable,t)}jQuery.tableDnD.currentTable=null}},serialize:function(){if(jQuery.tableDnD.currentTable){var e="";var t=jQuery.tableDnD.currentTable.id;var n=jQuery.tableDnD.currentTable.rows;for(var r=0;r<n.length;r++){if(e.length>0)e+="&";e+=t+"[]="+n[r].id}return e}else{return"Error: No Table id set, you need to set an id on your table and every row"}}};jQuery.fn.extend({tableDnD:jQuery.tableDnD.build})